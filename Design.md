# 需求分析
在当前流量为王的时代，QQ频道的出现使得用户可以更方便地关注自己感兴趣的话题，缓解用户沉默，降低屏蔽或者流失的概率。因此频道成员尤其是频道主，需要及时了解本频道内成员数量的增减变化，在合适的时机在本群内进行维持频道活跃度的操作。本模块解决的主要问题是：`帮助频道成员及时了解当前频道内的成员列表相对于昨天的变化`。

用例描述如下：
| 项目  |  内容 |
|---|---|
|用例编号   |  UC1 |
|  用例名称 |  检查频道成员数量变化 |
| 参与者  | 频道普通成员、机器人  |
| 触发条件  | 频道普通成员使用@指令对机器人发送内容为change/的消息  |
| 前置条件  | 无  |
| 后置条件  | 返回成员数量变化信息  |
| 正常流程  | 1. 频道普通成员使用@指令对机器人发送内容为change/的消息；2. 机器人返回成员数量变化信息 |


# 概要设计
考虑到查询频道内成员数量变化需要前一天的成员列表信息，由于本项目仅作测验，因此在本地维护一个sqlite数据库，存储昨天及之前加入本频道的人员列表。如果本地不存在数据库，则sqlite默认创建空白数据库并创建member表。

member表的数据库设计如下：
![](2022-05-20-11-24-09.png)
其中各字段描述如下：
- member_id：成员id
- guild_id：频道id
- joined_at：成员加入频道的时间

# 实现逻辑
通过WebSocket监听@事件，如果@消息的内容为`change/`，那么执行以下逻辑：
1. 从本地sqlite数据库查询昨天及之前加入频道的成员列表，封装为集合yestoday；
2. 从API查询目前的列表，封装为集合now；
3. yestoday-now（集合运算）是新退出的人，now-yestoday（集合运算）是新加入的人，使用这两个集合构造消息，通过WebSocket将消息发送到频道。
每日凌晨，调用定时任务以当前的now-yestoday和now-yestoday的结果更新本地数据库。

